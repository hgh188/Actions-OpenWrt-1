#
# 分离工具链构建 工具链工作流 (toolchain.yml)
# 2025.07.22
#
name: 编译工具链
on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - 'aarch64/Lede1806/Lede1806_FOL.config'
      - 'aarch64/Lede1806/1806diy-part1.sh'
      - 'aarch64/Lede1806/1806diy-part2.sh'

jobs:
  build-toolchain:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 部署编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi `docker images -q`
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d /usr/local/lib/android
          sudo -E apt -y purge azure-cli* docker* ghc* zulu* firefox google* dotnet* powershell* openjdk* mysql* mongodb* dotnet* snap* aspnetcore*
          sudo -E apt update
          sudo -E apt-get -y install build-essential gcc-11 g++-11 libstdc++-11-dev gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libncurses5-dev gawk git subversion gettext libssl-dev zlib1g-dev flex bison clang llvm
          sudo -E apt -y autoremove --purge
          sudo -E apt clean
          sudo timedatectl set-timezone "Asia/Shanghai"

      - name: 创建模拟物理磁盘
        run: |
          mnt_size=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 1)
          root_size=$(expr $(df -h / | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 4)
          sudo truncate -s "${mnt_size}"G /mnt/mnt.img
          sudo truncate -s "${root_size}"G /root.img
          sudo losetup /dev/loop6 /mnt/mnt.img
          sudo losetup /dev/loop7 /root.img
          sudo pvcreate /dev/loop6
          sudo pvcreate /dev/loop7
          sudo vgcreate github /dev/loop6 /dev/loop7
          sudo lvcreate -n runner -l 100%FREE github
          sudo mkfs.xfs /dev/github/runner
          sudo mkdir -p /workdir
          sudo mount /dev/github/runner /workdir
          sudo chown -R runner.runner /workdir
          df -Th

      - name: 下载源码
        working-directory: /workdir
        run: |
          git clone https://github.com/coolsnowwolf/lede -b master openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: 加载配置文件
        run: |
          [ -e aarch64/Lede1806/feeds.conf.default ] && cp aarch64/Lede1806/feeds.conf.default openwrt/feeds.conf.default
          [ -e aarch64/Lede1806/Lede1806_FOL.config ] && cp aarch64/Lede1806/Lede1806_FOL.config openwrt/.config
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make defconfig

      - name: 编译工具链
        run: |
          cd openwrt
          export CROSS_COMPILE=aarch64-linux-gnu-
          export ARCH=aarch64
          make -j$(nproc) toolchain/install V=s

      - name: 上传工具链
        uses: actions/upload-artifact@v4
        with:
          name: toolchain-aarch64
          path: openwrt/staging_dir/toolchain*
          retention-days: 30
